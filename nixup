#! /usr/bin/env bash
set -euo pipefail
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/stderr 2>&1 && pwd )"
set +x; source /run/secrets/nixup-secrets; set -x

nixargs=(--experimental-features "nix-command flakes") #ca-references ca-derivations recursive-nix")
buildargs=(
  #--option 'extra-substituters' 'https://colemickens.cachix.org https://nixpkgs-wayland.cachix.org https://arm.cachix.org https://thefloweringash-armv7.cachix.org'
  --option 'extra-binary-caches' 'https://cache.nixos.org https://colemickens.cachix.org https://nixpkgs-wayland.cachix.org https://arm.cachix.org https://thefloweringash-armv7.cachix.org'
  #--option 'extra-trusted-public-keys' 'colemickens.cachix.org-1:bNrJ6FfMREB4bd4BOjEN85Niu8VcPdQe4F4KxVsb/I4= nixpkgs-wayland.cachix.org-1:3lwxaILxMRkVhehr5StQprHdEo4IrE8sRho9R9HOLYA= arm.cachix.org-1:5BZ2kjoL1q6nWhlnrbAl+G7ThY7+HaBRD9PZzqZkbnM= thefloweringash-armv7.cachix.org-1:v+5yzBD2odFKeXbmC+OPWVqx4WVoIVO6UXgnSAWFtso='
  --option 'trusted-public-keys' 'cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= colemickens.cachix.org-1:bNrJ6FfMREB4bd4BOjEN85Niu8VcPdQe4F4KxVsb/I4= nixpkgs-wayland.cachix.org-1:3lwxaILxMRkVhehr5StQprHdEo4IrE8sRho9R9HOLYA= arm.cachix.org-1:5BZ2kjoL1q6nWhlnrbAl+G7ThY7+HaBRD9PZzqZkbnM= thefloweringash-armv7.cachix.org-1:v+5yzBD2odFKeXbmC+OPWVqx4WVoIVO6UXgnSAWFtso='
  --option 'build-cores' '0'
  --option 'narinfo-cache-negative-ttl' '0'
  --builders "
    ssh://cole@$(tailscale ip --6 porty) x86_64-linux /run/secrets/hydra_queue_runner_id_rsa - - ;
    ssh://cole@$(tailscale ip --6 sinkor) aarch64-linux /run/secrets/hydra_queue_runner_id_rsa;"
  --builders-use-substitutes
)
cache="colemickens"

## <ci-packet> #################################################
function packet-script() {
  LABEL="$1"
  RUNNER_TOKEN="${2}"
  set +x
  cat <<-EOF
#!/bin/bash
mkdir actions-runner && cd actions-runner
case \$(uname -m) in aarch64) ARCH="arm64" ;; amd64|x86_64) ARCH="x64" ;; esac && export RUNNER_ARCH=\${ARCH}
useradd -m runner
gpasswd --add runner wheel || true
gpasswd --add runner admin || true
gpasswd --add runner root || true
cd /home/runner
su runner -c "curl -O -L https://github.com/actions/runner/releases/download/v2.280.3/actions-runner-linux-\${RUNNER_ARCH}-2.280.3.tar.gz"
su runner -c "tar xzf ./actions-runner-linux-\${RUNNER_ARCH}-2.280.3.tar.gz"
su runner -c "env DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1 ./config.sh --unattended --url https://github.com/cole-mickens/nixcfg --token ${RUNNER_TOKEN} --labels ${LABEL} --ephemeral"
su runner -c "env DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1 ./run.sh"
EOF
  set -x
}
function packet-curl() { curl -H "X-Auth-Token: ${METAL_AUTH_TOKEN}" "$@" 2>/dev/null; }
function packet-spot() { packet-curl "https://api.packet.net/market/spot/prices" | jq ".spot_market_prices | keys[] as \$k | \"\(\$k) \(.[\$k][\"${1}\"].price)\"" | grep -v null; }
function packet-up() {
  packet-up-int "gha-x64" "c2.medium.x86"
  packet-up-int "gha-arm64" "c2.large.arm"
}
function packet-down() {
  packet-down-int 'gha-x64'
  packet-down-int 'gha-arm64'
}
function packet-up-int() {
  dev="${1}"
  plan="${2}"
  # TODO: find best facility for price+size
  token_x64="$(gh api -X POST /repos/cole-mickens/nixcfg/actions/runners/registration-token | jq -r .token)"
  token_arm64="$(gh api -X POST /repos/cole-mickens/nixcfg/actions/runners/registration-token | jq -r .token)"

  duration="1 hour";
  termtime="$(TZ=UTC date --date="${duration}" --iso-8601=seconds)"

  packet-down-int "${dev}"
  facility="sjc1"
  script="$(mktemp)"
  packet-script "${dev}" "${token_x64}" > "${script}"
  metal device create \
    --hostname "${dev}" \
    --plan "${plan}" \
    --facility "${facility}" \
    --operating-system "ubuntu_18_04" \
    --spot-instance --spot-price-max "0.5" \
    --termination-time="${termtime}" \
    --userdata-file "${script}"

  echo packet-wait "${dev}"
}
function packet-wait() {
  dev="${1}"
  set +x; echo -n "waiting for "${dev}" to finish provisioning."
  while true; do
    status="$(metal device get --output 'json' --search "${1}" | jq -r '.[0].state')"
    if [[ "${status}" != "provisioning" && "${status}" != "queued" ]]; then break; fi
    echo -n "."; sleep 2
  done; echo " done!"; set -x
  ip="$(metal device get --output 'json' --search "${1}" | jq -r '.[0].ip_addresses[] | select((.address_family==4) and (.public==true)).address')"
  ssh-keygen -R "${ip}"
  ssh-keyscan -H "${ip}" >> ~/.ssh/known_hosts

  # wait for runner
  set +x; echo "waiting for ${dev} runner."
  while true; do
    runnerid="$(gh api repos/cole-mickens/nixcfg/actions/runners | jq -r ".runners[] | select (.name == \"${dev}\").id")"
    if [[ "${runnerid:-""}" != "" ]]; then break; fi
    echo "waiting for ${dev} runner, waiting..."; sleep 10
  done; echo " done!"; set -x
}
function packet-down-int() {
  dev="${1}"
  id="$(metal device get --search "${dev}" --output json | jq -r '.[].id' || true)"
  if [[ "${id:-""}" != "" ]]; then
    echo "deleting ${dev}: ${id}, waiting..."; set +x
    while ! metal device delete --force --id "${id}" &>/dev/null; do echo "deleting ${dev}: ${id}, waiting..."; sleep 10; done; set -x
  fi
  runnerid="$(gh api repos/cole-mickens/nixcfg/actions/runners | jq -r ".runners[] | select (.name == \"${dev}\").id")"
  if [[ "${runnerid:-""}" != "" ]]; then
    gh api -X DELETE "repos/cole-mickens/nixcfg/actions/runners/${runnerid}" | jq
  fi
}
## </ci-packet> #################################################

## <ci> #################################################
function _nix() { nix "${nixargs[@]}" "${@}"; }
function _nix_build() { nix "${nixargs[@]}" build "${buildargs[@]}" "${@}"; }
function ci_nb_cache() {
  set -euo pipefail
  out="$(mktemp -d)"; rm -rf "${out}" && mkdir -p "${out}"
  
  if ci_check "${@}";
  then echo "******** nbu worked, exitting early"; return 0
  else echo "******** nbu did not work..."
  fi

  nix "${nixargs[@]}" build "${buildargs[@]}" --keep-going --out-link "${out}/result" ${@/#/'.#'}
  ls -al "${out}"
  readlink -f "${out}"/result* | tee /dev/stderr | cachix push colemickens
}
function ci_check() {
  set -euo pipefail
  nix-build-uncached \
    -build-flags "$(printf '\"%s\" ' "${nixargs[@]}" "${buildargs[@]}" "-j0" --no-link)" \
    "${buildargs[@]}" "${@}"
}
function up() {
  otherup # TODO: actually get this step done somewhere in our CI process....
  pkgup
  lockup
  ciup
}
function pkgup() {
  set -euo pipefail
  pushd "${DIR}/pkgs"
  ./update.sh
  popd
}
function otherup() {
  set -euo pipefail
  srcdirs=( "nixpkgs/cmpkgs"  "home-manager/cmhm"  "nixpkgs/master" "nixpkgs-wayland" "flake-firefox-nightly" )
  printf '%s\n' "${srcdirs[@]}" | \
    parallel --jobs $(nproc) --halt soon,fail=1 --tag --progress -- \
      "[[ ! -d "${HOME}/code/{.}" ]] || (git -C '${HOME}/code/{.}' pull --rebase && git -C '${HOME}/code/{.}' push origin HEAD -f)"
}
function lockup() {
  set -euo pipefail
  pushd "${DIR}"
  nix "${nixargs[@]}" flake update --no-registries --commit-lock-file
  outsh="$(mktemp -d)"
  nix build "${nixargs[@]}" "${buildargs[@]}" --out-link "${outsh}/result" ".#devShell.x86_64-linux.inputDerivation"
  readlink -f "${outsh}"/result* | tee /dev/stderr | cachix push colemickens
  popd
}
function ciup() {
  cachix watch-store -j2 "${cache}" & cachixpid=$!
  ci_nb_cache 'bundle'
  trap "kill -INT ${cachixpid}; wait ${cachixpid} || true" EXIT
}
## </ci> #################################################

## <remote> #################################################
function _remote() {
  remote="${1}"; buildattr="${2}"; target="${3}"; action="${4:-""}"
  rev="$(git rev-parse --short HEAD)"
  out="$(nix eval --raw "${buildattr}")"
  _nix_build --store "ssh-ng://${remote}" --eval-store "auto" "${buildattr}"
  nix copy --no-check-sigs --from "ssh-ng://${remote}" --to "ssh-ng://${target}" "${out}"
  if [[ "${action:-""}" == "activate" ]]; then
    ssh "${target}" "$(printf '\"%s\" ' sudo nix "${nixargs[@]}" build --no-link --profile /nix/var/nix/profiles/system "${out}")"
    ssh "${target}" "$(printf '\"%s\" ' sudo nix "${nixargs[@]}" shell -vv "${out}" -c switch-to-configuration switch)"
  fi
}
function tsip() {
  if [[ "${1}" == "$(hostname)" ]]; then printf "%s" "localhost";
  elif [[ "${1}" == "a64com" ]];    then printf "%s" "colemickens@aarch64.nixos.community";
  else                                   tailscale ip --6 ${1} | head -z -n1; fi
}
function pinebook()  { _remote "a64com"         ".#toplevels.pinebook"  "$(ip pinebook)" "activate"; }
function xeep()      { _remote "$(ip xeep)"     ".#toplevels.xeep"      "$(ip xeep)" "activate"; }
function raisin()    { _remote "$(ip raisin)"   ".#toplevels.raisin"    "$(ip raisin)" "activate"; }
function jeffhyper() { _remote "$(ip xeep)"     ".#toplevels.jeffhyper" "$(ip jeffhyper)" "activate"; }
function porty()     { _remote "$(ip porty)"    ".#toplevels.porty"     "$(ip porty)" "activate"; }
function rpizero1()  { _remote "$(tsip porty)"  ".#toplevels.rpizero1"  "192.168.145.120" "activate"; }
function rpizero2()  { _remote "$(tsip porty)"  ".#toplevels.rpizero2"  "$(ip rpizero2)" "activate"; }
function rpifour1()  { _remote "a64com"         ".#toplevels.rpifour1"  "$(ip rpifour1)" "activate"; }
function sinkor()    { _remote "a64com"         ".#toplevels.sinkor"    "$(ip sinkor)" "activate"; }
function pinephone() { _remote "a64com"         ".#toplevels.pinephone" "$(tsip pinephone)" "activate"; }
function bluephone() { _remote "a64com"         ".#toplevels.bluephone" "$(tsip bluephone)" "activate"; }
## </remote> #################################################

if [[ ! -z "${1:-""}" ]]; then cmd="${1}"; shift; fi
if [[ -z "${cmd:-""}" ]]; then
  cmd="up"
fi

set -x
"${cmd}" "${@}"
set +x
echo -e "\nexit=$?"
exit 0

#! /usr/bin/env bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/stderr 2>&1 && pwd )"
set -euo pipefail

export BLDR_X86="${BLDR_X86:-$(tailscale ip --6 slynux)}";
export BLDR_A64="${BLDR_A64:-"colemickens@aarch64.nixos.community"}";

function nixup() { "${DIR}/nixup" "${@}"; }

deploy_x86=( "carbon" "slynux" "raisin" "xeep" "jeffhyper" "openstick" )

_cmd="${1:-"upz"}"; shift || true;
case "${_cmd}" in
  "pkgup") printf "▒▒ pkgup ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    "${DIR}/pkgs/update.sh" "${@}"
  ;;
  "rpiup") printf "▒▒ rpiup ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
   "${DIR}/misc/rpi/rpipkgs.sh"
  ;;
  "shellup") printf "▒▒ shellup ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
   "${DIR}/misc/nixbuild.sh" "auto" "cachix:colemickens" ".#cache-dev"
  ;;
  "cacheup") printf "▒▒ cacheup ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    "${DIR}/misc/nixbuild.sh" "auto" "cachix:colemickens" ".#cache-all"
  ;;
  "lockup") printf "▒▒ lockup ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    nix "${nixargs[@]}" flake lock \
      --recreate-lock-file --commit-lock-file \
      "${DIR}"
  ;;
  "inputup") printf "▒▒ inputup ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    "${DIR}/misc/rebase-my-checkouts.sh";
  ;;

  "up") printf "▒▒ up ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    nixup inputup
    # nixup rpiup
    nixup lockup && nixup pkgup && nixup shellup
  ;;
  "upz")
    nixup up && nixup cacheup
    nixup deployall
    date
  ;;

  "build") "${DIR}/misc/nixbuild.sh" "auto" "cachix:colemickens" "${@}"; ;;
  "deploy")
    host="${1}"; shift
    printf "▒▒ deploy ${host} ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    nixup build ".#toplevels.${host}" "${@}" > /tmp/outres
    outres="$(cat /tmp/outres)"
    "${DIR}/misc/activate.sh" "${NIXUP_ACTION:-"switch"}" "${outres}" "${host}"
  ;;
  "deployall")
    printf "▒▒ deployall ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ \n" >/dev/stderr;
    for h in "${deploy_x86[@]}"; do
      nixup deploy "${h}";
    done
  ;;

  *) printf "!!! unknown command\n" >/dev/stderr; exit -1; ;;
esac

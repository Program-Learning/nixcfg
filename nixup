#! /usr/bin/env bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/stderr 2>&1 && pwd )"
#set +x; source /run/secrets/nixup-secrets; set -x
set -euo pipefail
cd "${DIR}"

function nix() { "${DIR}/misc/nix.sh" "${@}" ; }

cache="colemickens"
nixcfg="${DIR}"

rb="./misc/rbuild.sh"
ra="./misc/ractivate.sh"
commbox="${DIR}/misc/commbox.sh"
tsip="./misc/tsip.sh"

srcdirs=(
  "nixpkgs/cmpkgs"
  "home-manager/cmhm"
  "nixpkgs/master"
  "nixpkgs-wayland"
  "flake-firefox-nightly"
)
srcdirs=("${srcdirs[@]/#/"${HOME}/code/"}")

BLDR_X86="${BLDR_X86:-$("${tsip}" porty)}";
BLDR_A64="${BLDR_A64:-"colemickens@aarch64.nixos.community"}";

orig=("${@}")
cmd="${1:-"z"}"; shift || true

cleanup() {
  retval=$?
  if [[ "${ZELLIJ_LAYOUT_NAME:-""}" != "" && ${retval} != 0 ]]; then
    read -r -p "restart? [y/N] " response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]
    then
      exec "${0}" "${orig[@]}"
    fi
   fi
  echo -e "\nexit=$? (cmd=${cmd})" > /dev/stderr
  exit $retval;
}

update_input() {
  test -d "${1}/.git" || return 0;
  git -C "${1}" pull --rebase;
}
rebase_input() {
  test -d "${1}" || return 0
  git -C "${1}" pull --rebase
  git -C "${1}" push origin HEAD -f
}
export -f update_input
export -f rebase_input

trap "cleanup" EXIT

case "${cmd}" in
  "inputup")
    set -x
    parallel --verbose --tag update_input ::: "${srcdirs[@]}"
    parallel --verbose --tag rebase_input ::: "${srcdirs[@]}"
  ;;
  "pkgup")
    pushd ./pkgs;   ./update.sh "${@:-}";       popd
    [[ "${1:-""}" != "" ]] && "${rb}" "${BLDR_X86}" "$("${tsip}" "porty")" "${nixcfg}#${1}"
    "${0}" cacheshell
  ;;
  "lockup")
    nix "${nixargs[@]}" flake lock --recreate-lock-file --commit-lock-file
    "${0}" cacheshell
  ;;
  "cacheshell") "${rb}" "${BLDR_X86}" "localhost" ".#devShell.x86_64-linux.inputDerivation";;

  # individual build targets
  "jeffhyper" | "porty" | "raisin" | "xeep")
    out="$("${rb}" "${BLDR_X86}" "$("${tsip}" "${cmd}")" "${nixcfg}#toplevels.${cmd}" "${@}")"
    "${ra}" "$out" "$("${tsip}" "${cmd}")"
  ;;

  "rpifour1" | "rpithreebp1" | "rpizerotwo1" | \
  "sinkor" | "pinebook" | "blueline" | "enchilada")
    "${commbox}"
    out="$("${rb}" "${BLDR_A64}" "$("${tsip}" "${cmd}")" "${nixcfg}#toplevels.${cmd}" "${@}")"
    "${ra}" "$out" "$("${tsip}" "${cmd}")"
  ;;

  "towboot")
    "${commbox}"
    "${rb}" "${BLDR_A64}" "localhost" "${nixcfg}#images.rpifour1_towboot" "${@}"
  ;;

  "x86")
    "${rb}" "${BLDR_X86}" "$("${tsip}" porty)"  "${nixcfg}#hydraBundles.x86_64-linux.toplevels" "${@}"
  ;;
  "a64")
    "${commbox}"
    "${rb}" "${BLDR_A64}" "$("${tsip}" porty)"  "${nixcfg}#hydraBundles.aarch64-linux.toplevels" "${@}"
  ;;

  "z")
    "${0}" inputup
    "${0}" lockup
    "${0}" pkgup
    "${0}" cacheshell
    "${0}" build
    "${0}" deploy
  ;;
  "build")
    env ZELLIJ_LAYOUT_NAME="nixup.build" \
      zellij --layout-path "${nixcfg}/nixup.build.zellij"
  ;;
  "deploy")
    env ZELLIJ_LAYOUT_NAME="nixup.deploy" \
      zellij --layout-path "${nixcfg}/nixup.deploy.zellij"
  ;;
esac

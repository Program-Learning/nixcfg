#! /usr/bin/env bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/stderr 2>&1 && pwd )"
set +x; source /run/secrets/nixup-secrets; set -x
set -euo pipefail
cd "${DIR}"

cache="colemickens"
nixcfg="${HOME}/code/nixcfg"

nix="${DIR}/misc/nix.sh"
rb="./misc/rbuild.sh"
ra="./misc/ractivate.sh"
cb="${DIR}/misc/commbox.sh"
tsip="./misc/tsip.sh"
a64com="colemickens@aarch64.nixos.community"

BLDR_X86="${BLDR_X86:-$("${tsip}" porty)}";
BLDR_A64="${BLDR_A64:-${a64com}}";

cmd="${1:-"upall"}"; shift || true

cleanup() {
  if [[ "${ZELLIJ_LAYOUT_NAME:-""}" != "" ]]; then
    read -p 'Press enter to continue'
  fi
}
trap "cleanup" EXIT

case "${cmd}" in
  "inputup")
    srcdirs=( "nixpkgs/cmpkgs" "home-manager/cmhm" "nixpkgs/master" "nixpkgs-wayland" "flake-firefox-nightly" )
    for i in "${srcdirs[@]}"; do
      if [[ -d "$HOME/code/${i}" ]]; then
        git -C "$HOME/code/${i}" pull --rebase \
        && git -C "$HOME/code/${i}" push origin HEAD -f
      fi
    done
  ;;
  "pkgup")
    pushd ./pkgs
    ./update.sh "${@:-}"
    popd
    "${0}" cacheshell
  ;;
  "lockup")
    "${nix}" "${nixargs[@]}" flake lock --recreate-lock-file --commit-lock-file
    "${0}" cacheshell
  ;;
  "cacheshell") "${rb}" "${BLDR_X86}" "localhost" ".#devShell.x86_64-linux.inputDerivation";;

  # individual build targets
  "jeffhyper" | "porty" | "raisin" | "xeep")
    out="$("${rb}" "${BLDR_X86}" "$("${tsip}" "${cmd}")" "${nixcfg}#toplevels.${cmd}" "${@}")"
    "${ra}" "$out" "$("${tsip}" "${cmd}")"
  ;;

  "rpifour1" | "rpithreebp1" | "rpizerotwo1")
    "${cb}"
    out="$("${rb}" "${BLDR_A64}" "$("${tsip}" "${cmd}")" "${nixcfg}#toplevels.${cmd}" "${@}")" \
      --override-input 'nixpkgs' "${HOME}/code/nixpkgs/rpi-updates-auto" \
      --override-input 'tow-boot' "${HOME}/code/tow-boot"
    "${ra}" "$out" "$("${tsip}" "${cmd}")"
  ;;

  # "rpifour1" | "rpithreebp1" | "rpizerotwo1" |
  "sinkor" | "pinebook" | "blueline" | "enchilada")
    "${cb}"
    out="$("${rb}" "${BLDR_A64}" "$("${tsip}" "${cmd}")" "${nixcfg}#toplevels.${cmd}" "${@}")"
    "${ra}" "$out" "$("${tsip}" "${cmd}")"
  ;;

  "towboot")
    "${cb}"
    "${rb}" "${BLDR_A64}" "localhost" "${nixcfg}#images.rpifour1_towboot" "${@}"
  ;;

  "x86")
    "${rb}" "${BLDR_X86}" "$("${tsip}" porty)"  "${nixcfg}#topbundles.x86_64-linux" "${@}"
  ;;
  "a64")
    "${cb}"
    "${rb}" "${BLDR_A64}" "$("${tsip}" porty)"  "${nixcfg}#topbundles.aarch64-linux" "${@}"
  ;;

  "z")
    "${0}" inputup
    "${0}" lockup
    "${0}" pkgup
    "${0}" cacheshell
    env ZELLIJ_LAYOUT_NAME="nixup" \
      zellij --layout-path "${nixcfg}/nixup.zellij"
  ;;
  "zz")
    "${0}" z
  ;;
esac

echo -e "\nexit=$?" > /dev/stderr
exit 0

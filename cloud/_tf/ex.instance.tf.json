{
    "data": {
        "oci_core_instance_devices": {
            "test_instance_devices": [
                {
                    "count": "${var.num_instances}",
                    "instance_id": "${oci_core_instance.test_instance[count.index].id}"
                }
            ]
        },
        "oci_core_volume_backup_policies": {
            "test_predefined_volume_backup_policies": [
                {
                    "filter": [
                        {
                            "name": "display_name",
                            "values": [
                                "silver"
                            ]
                        }
                    ]
                }
            ]
        },
        "oci_identity_availability_domain": {
            "ad": [
                {
                    "ad_number": 1,
                    "compartment_id": "${var.tenancy_id}"
                }
            ]
        }
    },
    "output": {
        "boot_volume_ids": [
            {
                "value": [
                    "${oci_core_instance.test_instance.*.boot_volume_id}"
                ]
            }
        ],
        "instance_devices": [
            {
                "value": [
                    "${data.oci_core_instance_devices.test_instance_devices.*.devices}"
                ]
            }
        ],
        "instance_private_ips": [
            {
                "value": [
                    "${oci_core_instance.test_instance.*.private_ip}"
                ]
            }
        ],
        "instance_public_ips": [
            {
                "value": [
                    "${oci_core_instance.test_instance.*.public_ip}"
                ]
            }
        ],
        "silver_policy_id": [
            {
                "value": "${data.oci_core_volume_backup_policies.test_predefined_volume_backup_policies.volume_backup_policies[0].id}"
            }
        ]
    },
    "provider": {
        "oci": [
            {
                "fingerprint": "${var.fingerprint}",
                "private_key_path": "${var.private_key_path}",
                "region": "${var.region}",
                "tenancy_ocid": "${var.tenancy_id}",
                "user_ocid": "${var.user_ocid}"
            }
        ]
    },
    "resource": {
        "null_resource": {
            "remote-exec": [
                {
                    "count": "${var.num_instances * var.num_iscsi_volumes_per_instance}",
                    "depends_on": [
                        "${oci_core_instance.test_instance}",
                        "${oci_core_volume_attachment.test_block_attach}"
                    ],
                    "provisioner": {
                        "remote-exec": [
                            {
                                "connection": [
                                    {
                                        "agent": false,
                                        "host": "${oci_core_instance.test_instance[count.index % var.num_instances].public_ip}",
                                        "private_key": "${var.ssh_private_key}",
                                        "timeout": "30m",
                                        "user": "opc"
                                    }
                                ],
                                "inline": [
                                    "touch ~/IMadeAFile.Right.Here",
                                    "sudo iscsiadm -m node -o new -T ${oci_core_volume_attachment.test_block_attach[count.index].iqn} -p ${oci_core_volume_attachment.test_block_attach[count.index].ipv4}:${oci_core_volume_attachment.test_block_attach[count.index].port}",
                                    "sudo iscsiadm -m node -o update -T ${oci_core_volume_attachment.test_block_attach[count.index].iqn} -n node.startup -v automatic",
                                    "sudo iscsiadm -m node -T ${oci_core_volume_attachment.test_block_attach[count.index].iqn} -p ${oci_core_volume_attachment.test_block_attach[count.index].ipv4}:${oci_core_volume_attachment.test_block_attach[count.index].port} -o update -n node.session.auth.authmethod -v CHAP",
                                    "sudo iscsiadm -m node -T ${oci_core_volume_attachment.test_block_attach[count.index].iqn} -p ${oci_core_volume_attachment.test_block_attach[count.index].ipv4}:${oci_core_volume_attachment.test_block_attach[count.index].port} -o update -n node.session.auth.username -v ${oci_core_volume_attachment.test_block_attach[count.index].chap_username}",
                                    "sudo iscsiadm -m node -T ${oci_core_volume_attachment.test_block_attach[count.index].iqn} -p ${oci_core_volume_attachment.test_block_attach[count.index].ipv4}:${oci_core_volume_attachment.test_block_attach[count.index].port} -o update -n node.session.auth.password -v ${oci_core_volume_attachment.test_block_attach[count.index].chap_secret}",
                                    "sudo iscsiadm -m node -T ${oci_core_volume_attachment.test_block_attach[count.index].iqn} -p ${oci_core_volume_attachment.test_block_attach[count.index].ipv4}:${oci_core_volume_attachment.test_block_attach[count.index].port} -l"
                                ]
                            }
                        ]
                    }
                }
            ]
        },
        "oci_core_default_route_table": {
            "default_route_table": [
                {
                    "display_name": "DefaultRouteTable",
                    "manage_default_resource_id": "${oci_core_vcn.test_vcn.default_route_table_id}",
                    "route_rules": [
                        {
                            "destination": "0.0.0.0/0",
                            "destination_type": "CIDR_BLOCK",
                            "network_entity_id": "${oci_core_internet_gateway.test_internet_gateway.id}"
                        }
                    ]
                }
            ]
        },
        "oci_core_instance": {
            "test_instance": [
                {
                    "availability_domain": "${data.oci_identity_availability_domain.ad.name}",
                    "compartment_id": "${var.compartment_ocid}",
                    "count": "${var.num_instances}",
                    "create_vnic_details": [
                        {
                            "assign_private_dns_record": true,
                            "assign_public_ip": true,
                            "display_name": "Primaryvnic",
                            "hostname_label": "exampleinstance${count.index}",
                            "subnet_id": "${oci_core_subnet.test_subnet.id}"
                        }
                    ],
                    "defined_tags": {
                        "${oci_identity_tag_namespace.tag-namespace1.name}.${oci_identity_tag.tag2.name}": "awesome-app-server"
                    },
                    "display_name": "TestInstance${count.index}",
                    "freeform_tags": {
                        "freeformkey${count.index}": "freeformvalue${count.index}"
                    },
                    "metadata": {
                        "ssh_authorized_keys": "${var.ssh_public_key}",
                        "user_data": "${base64encode(file(\"./userdata/bootstrap\"))}"
                    },
                    "preemptible_instance_config": [
                        {
                            "preemption_action": [
                                {
                                    "preserve_boot_volume": false,
                                    "type": "TERMINATE"
                                }
                            ]
                        }
                    ],
                    "shape": "${var.instance_shape}",
                    "shape_config": [
                        {
                            "memory_in_gbs": "${var.instance_shape_config_memory_in_gbs}",
                            "ocpus": "${var.instance_ocpus}"
                        }
                    ],
                    "source_details": [
                        {
                            "source_id": "${var.flex_instance_image_ocid[var.region]}",
                            "source_type": "image"
                        }
                    ],
                    "timeouts": [
                        {
                            "create": "60m"
                        }
                    ]
                }
            ]
        },
        "oci_core_internet_gateway": {
            "test_internet_gateway": [
                {
                    "compartment_id": "${var.compartment_ocid}",
                    "display_name": "TestInternetGateway",
                    "vcn_id": "${oci_core_vcn.test_vcn.id}"
                }
            ]
        },
        "oci_core_subnet": {
            "test_subnet": [
                {
                    "availability_domain": "${data.oci_identity_availability_domain.ad.name}",
                    "cidr_block": "10.1.20.0/24",
                    "compartment_id": "${var.compartment_ocid}",
                    "dhcp_options_id": "${oci_core_vcn.test_vcn.default_dhcp_options_id}",
                    "display_name": "TestSubnet",
                    "dns_label": "testsubnet",
                    "route_table_id": "${oci_core_vcn.test_vcn.default_route_table_id}",
                    "security_list_ids": [
                        "${oci_core_vcn.test_vcn.default_security_list_id}"
                    ],
                    "vcn_id": "${oci_core_vcn.test_vcn.id}"
                }
            ]
        },
        "oci_core_vcn": {
            "test_vcn": [
                {
                    "cidr_block": "10.1.0.0/16",
                    "compartment_id": "${var.compartment_ocid}",
                    "display_name": "TestVcn",
                    "dns_label": "testvcn"
                }
            ]
        },
        "oci_core_volume": {
            "test_block_volume": [
                {
                    "availability_domain": "${data.oci_identity_availability_domain.ad.name}",
                    "compartment_id": "${var.compartment_ocid}",
                    "count": "${var.num_instances * var.num_iscsi_volumes_per_instance}",
                    "display_name": "TestBlock${count.index}",
                    "size_in_gbs": "${var.db_size}"
                }
            ],
            "test_block_volume_paravirtualized": [
                {
                    "availability_domain": "${data.oci_identity_availability_domain.ad.name}",
                    "compartment_id": "${var.compartment_ocid}",
                    "count": "${var.num_instances * var.num_paravirtualized_volumes_per_instance}",
                    "display_name": "TestBlockParavirtualized${count.index}",
                    "size_in_gbs": "${var.db_size}"
                }
            ]
        },
        "oci_core_volume_attachment": {
            "test_block_attach": [
                {
                    "attachment_type": "iscsi",
                    "count": "${var.num_instances * var.num_iscsi_volumes_per_instance}",
                    "device": "${count.index == 0 ? \"/dev/oracleoci/oraclevdb\" : \"\"}",
                    "instance_id": "${oci_core_instance.test_instance[floor(count.index / var.num_iscsi_volumes_per_instance)].id}",
                    "use_chap": true,
                    "volume_id": "${oci_core_volume.test_block_volume[count.index].id}"
                }
            ],
            "test_block_volume_attach_paravirtualized": [
                {
                    "attachment_type": "paravirtualized",
                    "count": "${var.num_instances * var.num_paravirtualized_volumes_per_instance}",
                    "instance_id": "${oci_core_instance.test_instance[floor(count.index / var.num_paravirtualized_volumes_per_instance)].id}",
                    "volume_id": "${oci_core_volume.test_block_volume_paravirtualized[count.index].id}"
                }
            ]
        },
        "oci_core_volume_backup_policy_assignment": {
            "policy": [
                {
                    "asset_id": "${oci_core_instance.test_instance[count.index].boot_volume_id}",
                    "count": "${var.num_instances}",
                    "policy_id": "${data.oci_core_volume_backup_policies.test_predefined_volume_backup_policies.volume_backup_policies[0].id}"
                }
            ]
        }
    },
    "variable": {
        "compartment_ocid": [
            {}
        ],
        "db_size": [
            {
                "default": "50"
            }
        ],
        "fingerprint": [
            {}
        ],
        "flex_instance_image_ocid": [
            {
                "default": {
                    "eu-frankfurt-1": "ocid1.image.oc1.eu-frankfurt-1.aaaaaaaadvi77prh3vjijhwe5xbd6kjg3n5ndxjcpod6om6qaiqeu3csof7a",
                    "uk-london-1": "ocid1.image.oc1.uk-london-1.aaaaaaaaw5gvriwzjhzt2tnylrfnpanz5ndztyrv3zpwhlzxdbkqsjfkwxaq",
                    "us-ashburn-1": "ocid1.image.oc1.iad.aaaaaaaa6tp7lhyrcokdtf7vrbmxyp2pctgg4uxvt4jz4vc47qoc2ec4anha",
                    "us-phoenix-1": "ocid1.image.oc1.phx.aaaaaaaa6hooptnlbfwr5lwemqjbu3uqidntrlhnt45yihfj222zahe7p3wq"
                },
                "type": "${map(string)}"
            }
        ],
        "instance_image_ocid": [
            {
                "default": {
                    "eu-frankfurt-1": "ocid1.image.oc1.eu-frankfurt-1.aaaaaaaaitzn6tdyjer7jl34h2ujz74jwy5nkbukbh55ekp6oyzwrtfa4zma",
                    "uk-london-1": "ocid1.image.oc1.uk-london-1.aaaaaaaa32voyikkkzfxyo4xbdmadc2dmvorfxxgdhpnk6dw64fa3l4jh7wa",
                    "us-ashburn-1": "ocid1.image.oc1.iad.aaaaaaaageeenzyuxgia726xur4ztaoxbxyjlxogdhreu3ngfj2gji3bayda",
                    "us-phoenix-1": "ocid1.image.oc1.phx.aaaaaaaaoqj42sokaoh42l76wsyhn3k2beuntrh5maj3gmgmzeyr55zzrwwa"
                },
                "type": "${map(string)}"
            }
        ],
        "instance_ocpus": [
            {
                "default": 1
            }
        ],
        "instance_shape": [
            {
                "default": "VM.Standard.E3.Flex"
            }
        ],
        "instance_shape_config_memory_in_gbs": [
            {
                "default": 1
            }
        ],
        "num_instances": [
            {
                "default": "3"
            }
        ],
        "num_iscsi_volumes_per_instance": [
            {
                "default": "1"
            }
        ],
        "num_paravirtualized_volumes_per_instance": [
            {
                "default": "2"
            }
        ],
        "private_key_path": [
            {}
        ],
        "region": [
            {}
        ],
        "ssh_private_key": [
            {}
        ],
        "ssh_public_key": [
            {}
        ],
        "tag_namespace_description": [
            {
                "default": "Just a test"
            }
        ],
        "tag_namespace_name": [
            {
                "default": "testexamples-tag-namespace"
            }
        ],
        "tenancy_ocid": [
            {}
        ],
        "user_ocid": [
            {}
        ]
    }
}